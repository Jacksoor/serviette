{{define "title"}}{{.ScriptName}} | Scripts{{end}}

{{define "head"}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/codemirror.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/mode/lua/lua.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/mode/shell/shell.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/addon/edit/matchbrackets.min.js"></script>
{{end}}

{{define "body"}}
<h1>Script: <samp>{{.ScriptName}}</samp></h1>
<form method="POST" action="/scripts/{{.ScriptName}}" id="editorForm">
    <p>
        <label>
            <strong>Description</strong><br>
            <textarea name="description">{{.Meta.Description}}</textarea>
        </label>
    </p>
    <p>
        <label>
            <input type="checkbox" name="published"{{if .Meta.Published}} checked{{end}}>
            <strong>Published?</strong>
        </label>
    </p>

    <p>
        <textarea name="content" id="editor">{{.ScriptContent}}</textarea>
    </p>

    <p>
    <a href="https://kobun4.readthedocs.io/en/latest/scripting/index.html" target="docs">Documentation reference</a>
    </p>

    <p>
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <button type="submit">Save</button>
    </p>
</form>

<form method="POST" action="/scripts/{{.ScriptName}}/delete" id="deleteForm">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
    <button type="submit" onclick="return confirm('Are you sure you want to delete this script? This is IRREVERSIBLE!')">Delete</button>
</form>

<nav>
    <ul>
        <li><a href="/">Return to account home page</a></li>
    </ul>
</nav>

<script>
(function() {
    var KNOWN_SYNTAXES = {
        '/bin/bash': 'shell',
        '/bin/sh': 'shell',
        '/usr/bin/python3': 'python',
        '/usr/bin/lua': 'lua',
        '/usr/bin/node': 'javascript',
    };

    var unsaved = false;

    document.getElementById('editorForm').onsubmit = function () {
        unsaved = false;
    };

    document.getElementById('deleteForm').onsubmit = function () {
        unsaved = false;
    };

    window.onbeforeunload = function () {
        if (unsaved) {
            return "You have unsaved changes.";
        }
    };

    var cm = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode: 'null',
        lineNumbers: true,
        viewportMargin: Infinity,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        matchBrackets: true,
        extraKeys: {
            Tab: function (cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                } else {
                    cm.replaceSelection(cm.getOption("indentWithTabs") ? "\t" : Array(cm.getOption("indentUnit") + 1).join(" "), "end", "+input");
                }
            }
        }
    });

    function guessSyntax() {
        var line1 = cm.getLine(0);
        if (line1.substring(0, 2) !== '#!') {
            cm.setOption('mode', null);
            return;
        }

        var prog = line1.substring(2);
        var spaceIndex = prog.indexOf(' ');
        if (spaceIndex !== -1) {
            prog = prog.substring(0, spaceIndex);
        }

        cm.setOption('mode', KNOWN_SYNTAXES[prog] || null);
    }

    guessSyntax();

    cm.on("changes", function (cm, changes) {
        unsaved = true;

        if (!changes.some(function (change) {
            return change.from.line == 0;
        })) {
            return;
        }
        guessSyntax();
    });
})();</script>
{{end}}
