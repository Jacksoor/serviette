syntax = "proto3";

package kobun4.executor.scripts.v1;

option go_package = "v1pb";

message Capabilities {
    bool bill_usage_to_executing_account = 1;
    int64 withdrawal_limit = 2;
}

message Context {
    string bridge_name = 1;
    string mention = 2;
    string source = 3;
    string server = 4;
    string channel = 5;
    bool is_private = 6;
    string output_format = 7;

    string script_account_handle = 8;
    string billing_account_handle = 9;
    string executing_account_handle = 10;

    map<string, string> extra = 1000;
}

message CreateRequest {
    bytes account_handle = 1;
    string name = 2;
    Capabilities requested_capabilities = 3;
    bytes content = 4;
}

message CreateResponse {
}

message ListRequest {
    bytes account_handle = 1;
}

message ListResponse {
    repeated string name = 1;
}

message DeleteRequest {
    bytes account_handle = 1;
    string name = 2;
}

message DeleteResponse {
}

message ExecuteRequest {
    bytes executing_account_handle = 1;
    bytes executing_account_key = 2;

    bytes script_account_handle = 3;

    string name = 4;
    string rest = 5;
    Context context = 6;
}

message ExecuteResponse {
    message Withdrawal {
        bytes target_account_handle = 1;
        int64 amount = 2;
    }

    Context context = 1;
    uint32 wait_status = 2;
    bytes stdout = 4;
    bytes stderr = 5;
    int64 usage_cost = 6;
    repeated Withdrawal withdrawal = 7;
}

message GetContentRequest {
    bytes account_handle = 1;
    string name = 2;
}

message GetContentResponse {
    bytes content = 1;
}

message GetRequestedCapabilitiesRequest {
    bytes account_handle = 1;
    string name = 2;
}

message GetRequestedCapabilitiesResponse {
    Capabilities capabilities = 1;
}

message SetAccountCapabilitiesRequest {
    bytes executing_account_handle = 1;
    bytes script_account_handle = 2;
    string script_name = 3;
    Capabilities capabilities = 4;
}

message SetAccountCapabilitiesResponse {
}

message GetAccountCapabilitiesRequest {
    bytes executing_account_handle = 1;
    bytes script_account_handle = 2;
    string script_name = 3;
}

message GetAccountCapabilitiesResponse {
    Capabilities capabilities = 1;
}

message ResolveAliasRequest {
    string name = 1;
}

message ResolveAliasResponse {
    bytes account_handle = 1;
    string script_name = 2;
    int64 expiry_time_unix = 3;
}

message SetAliasRequest {
    string name = 1;
    bytes account_handle = 2;
    string script_name = 3;
    int64 expiry_time_unix = 4;
}

message SetAliasResponse {
}

message ListAliasesRequest {
}

message ListAliasesResponse {
    message Entry {
        string name = 1;
        bytes account_handle = 2;
        string script_name = 3;
        int64 expiry_time_unix = 4;
    }

    repeated Entry entry = 1;
}

service Scripts {
    rpc Create(CreateRequest) returns (CreateResponse) { }
    rpc List(ListRequest) returns (ListResponse) { }
    rpc Delete(DeleteRequest) returns (DeleteResponse) { }
    rpc Execute(ExecuteRequest) returns (ExecuteResponse) { }

    rpc GetContent(GetContentRequest) returns (GetContentResponse) { }

    rpc GetRequestedCapabilities(GetRequestedCapabilitiesRequest) returns (GetRequestedCapabilitiesResponse) { }

    rpc SetAccountCapabilities(SetAccountCapabilitiesRequest) returns (SetAccountCapabilitiesResponse) { }
    rpc GetAccountCapabilities(GetAccountCapabilitiesRequest) returns (GetAccountCapabilitiesResponse) { }

    rpc ResolveAlias(ResolveAliasRequest) returns (ResolveAliasResponse) { }
    rpc SetAlias(SetAliasRequest) returns (SetAliasResponse) { }
    rpc ListAliases(ListAliasesRequest) returns (ListAliasesResponse) { }
}
