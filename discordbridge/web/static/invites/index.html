<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Invites | Kobun for Discord</title>
</head>
<body>
    <div id="steps">
        <div class="step">
            <p>
                Thank you again for your interest in Kobun. This is a short automated process to get Kobun for your server, and shouldn't take more than 5 minutes.
            </p>
            <p>
                <strong>This invitation link is only good for one use.</strong>
            </p>
            <p>
                <button type="button" onclick="nextStep()">Let's go!</button>
            </p>
        </div>

        <div class="step">
            <h2>Step 0. Create a role for Kobun administrators.</h2>
            <p>
                Before you do the step below, make sure you have a role created for any users who will have administrative privileges for Kobun. Only users with this role will be recognized as Kobun administrators, so you should remember to grant yourself this role.
            </p>
            <p>
                <button type="button" onclick="nextStep()">I did it!</button>
            </p>
        </div>

        <div class="step">
            <h2>Step 1. Authorize Kobun for your server.</h2>
            <p>
                Kobun needs to have permissions to be in your server.
            </p>
            <p>
                <button id="authorize">Authorize</button>
            </p>
        </div>

        <div class="step">
            <h2>Step 2. Select a role to use for admininstration.</h2>
            <p>
                You'll need to pick the role you created in step 0 here.
            </p>
            <form id="roleSelectForm">
                <select name="role" required>
                </select>
                <button type="submit">Choose role</button>
            </form>
        </div>

        <div class="step">
            <h2>You're done!</h2>
            <p>
                Close this page and enjoy!
            </p>
            <p>
                <strong>This invitation link is no longer valid.</strong>
            </p>
        </div>
    </div>

    <script>
    var stepsEl = document.getElementById('steps');
    var stepEls = Array.prototype.slice.call(stepsEl.getElementsByClassName('step'));
    var pendingStepEls = stepEls.slice();

    var inviteID = window.location.search.substring(1);

    function clearStepsEl() {
        for (var i = 0; i < stepEls.length; ++i) {
            stepEls[i].style.display = 'none';
        }
    }

    var roleSelectFormEl = document.getElementById('roleSelectForm');

    function nextStep() {
        clearStepsEl();
        pendingStepEls.shift().style.display = '';
    }

    function req(method, url, body, cb) {
        var xhr = new XMLHttpRequest();
        xhr.open(method, url);
        if (method === 'POST') {
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        }
        xhr.onload = function() {
            if (xhr.status !== 200) {
                cb(new Error(xhr.responseText));
            } else {
                if (xhr.responseText) {
                    cb(null, JSON.parse(xhr.responseText));
                } else {
                    cb(null, null);
                }
            }
        };
        xhr.send(body);
    }

    function onKobunInviteBound() {
        req('GET', '/api/v1/invites/roles?invite_id=' + encodeURIComponent(inviteID), null, function (err, resp) {
            if (err !== null) {
                alert('ERROR: ' + err);
                return;
            }

            nextStep();

            for (var k in resp.roles) {
                if (!Object.prototype.hasOwnProperty.call(resp.roles, k)) {
                    continue;
                }

                var optionEl = document.createElement('option');
                optionEl.value = k;
                optionEl.textContent = resp.roles[k];
                roleSelectFormEl.elements.role.appendChild(optionEl);
            }

            roleSelectFormEl.onsubmit = function (e) {
                e.preventDefault();

                req('POST', '/api/v1/invites/consume', 'invite_id=' + encodeURIComponent(inviteID) + '&role_id=' + encodeURIComponent(roleSelectFormEl.elements.role.value), function (err, resp) {
                    if (err !== null) {
                        alert("ERROR: " + err);
                        return;
                    }

                    nextStep();
                });
            };
        });
    }

    document.getElementById('authorize').onclick = function () {
        window.open('/api/v1/invites/use?invite_id=' + encodeURIComponent(inviteID), 'oauthDialog', 'width=800, height=600');
    };

    nextStep();
    </script>
</body>
</html>
